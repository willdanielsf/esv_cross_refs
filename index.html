<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bootstrap Table</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container my-4">
        <div class="row mb-3">
            <div class="col">
                <label for="book-select" class="form-label">Book</label>
                <select id="book-select" class="form-select"></select>
            </div>
            <div class="col">
                <label for="chapter-select" class="form-label">Chapter</label>
                <select id="chapter-select" class="form-select"></select>
            </div>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="ot-checkbox" value="OT" checked>
            <label class="form-check-label" for="ot-checkbox">OT</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="nt-checkbox" value="NT" checked>
            <label class="form-check-label" for="nt-checkbox">NT</label>
        </div>        
        <button id="submit-btn" class="btn btn-primary mb-3">Submit</button>
        <table class="table table-striped" id="data-table">
            <thead>
                <tr>
                    <th>Verse</th>
                    <th>All Refs</th>
                    <th>Testament</th>
                    <th>Reverse Ref</th>
                    <th>Cross Ref Text</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        d3.csv("cross_references.csv").then(data => {
            const bookSelect = document.getElementById("book-select");
            const chapterSelect = document.getElementById("chapter-select");
            const tableBody = document.querySelector("#data-table tbody");
    
            // Populate Book and Chapter dropdowns
            const books = [...new Set(data.map(row => row.Book))];
            const chapters = [...new Set(data.map(row => row.Chapter))];
            books.forEach(book => {
                const option = document.createElement("option");
                option.value = book;
                option.textContent = book;
                bookSelect.appendChild(option);
            });
            chapters.forEach(chapter => {
                const option = document.createElement("option");
                option.value = chapter;
                option.textContent = chapter;
                chapterSelect.appendChild(option);
            });
    
            // Function to filter data by selected book, chapter, and checked Testaments
            const filterData = (book, chapter) => {
                const includeOT = document.getElementById("ot-checkbox").checked;
                const includeNT = document.getElementById("nt-checkbox").checked;

                return data.filter(row => {
                    const matchBook = book ? row.Book === book : true;
                    const matchChapter = chapter ? row.Chapter === chapter : true;
                    const matchTestament =
                        (row.Testament === "OT" && includeOT) ||
                        (row.Testament === "NT" && includeNT);

                    return matchBook && matchChapter && matchTestament;
                });
            };
    
            // Function to build Testament URL
            const buildTestamentUrl = (filteredData, book, chapter, verse, testament) => {
                const matchingRefs = filteredData
                    .filter(row =>
                        row.Book === book &&
                        row.Chapter === chapter &&
                        row.Verse === verse &&
                        row.Testament === testament
                    )
                    .map(row => row["Reverse Ref"])
                    .filter(ref => ref);

                if (matchingRefs.length > 0) {
                    const url = `https://esv.org/${matchingRefs.map(ref => ref.replace(/ /g, '+')).join(';')}`;
                    return `<a href="${url}" target="_blank">${testament}</a>`;
                }
                return testament || "";
            };
    
            // Function to build All Refs URL
            const buildAllRefsUrl = (filteredData, book, chapter, verse) => {
                const matchingRefs = filteredData
                    .filter(row => row.Book === book && row.Chapter === chapter && row.Verse === verse)
                    .map(row => row["Reverse Ref"])
                    .filter(ref => ref);

                if (matchingRefs.length > 0) {
                    const url = `https://esv.org/${matchingRefs.map(ref => ref.replace(/ /g, '+')).join(';')}`;
                    return `<a href="${url}" target="_blank">View Collection</a>`;
                }
                return "No Refs";
            };
    
            // Function to update the table with filtered data
            const updateTable = (filteredData) => {
                // Clear the table body
                tableBody.innerHTML = "";
    
                // Populate the table with filtered data
                filteredData.forEach(row => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${row.Verse || ""}</td>
                        <td>${buildAllRefsUrl(filteredData, row.Book, row.Chapter, row.Verse)}</td>
                        <td>${buildTestamentUrl(filteredData, row.Book, row.Chapter, row.Verse, row.Testament)}</td>
                        <td>${row["Reverse Ref"] ? `<a href="https://esv.org/${row["Reverse Ref"].replace(/ /g, '+')}" target="_blank">${row["Reverse Ref"]}</a>` : ""}</td>
                        <td>${row["Cross Ref Text"] || ""}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            };
    
            // Handle submit button click
            document.getElementById("submit-btn").addEventListener("click", () => {
                const selectedBook = bookSelect.value;
                const selectedChapter = chapterSelect.value;
                const filteredData = filterData(selectedBook, selectedChapter);
                updateTable(filteredData);
            });
        });
    </script>
</body>
</html>
